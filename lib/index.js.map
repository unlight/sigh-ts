{"version":3,"sources":["..\\src\\index.js"],"names":[],"mappings":"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","file":"src/index.js","sourceRoot":"src","sourcesContent":["import {log, Event} from \"sigh-core\";\nimport {existsSync, readFileSync} from \"fs\";\nimport * as path from \"path\";\nimport pkgDir from \"pkg-dir\";\nimport ts from \"typescript\";\nimport _ from \"lodash\";\nimport logdiagnostics from \"./logdiagnostics\";\n\nconst npmPackage = pkgDir.sync();\nconst typingsIndex = path.resolve(npmPackage, \"typings/index.d.ts\");\n\nexport default function (op, compilerOptions = {}) {\n    compilerOptions = getCompilerOptions(compilerOptions);\n    var logd = _.get(compilerOptions, \"logd\", logdiagnostics);\n    var files = {};\n    var _existsSync = _.memoize(existsSync);\n    var _readFileSync = _.memoize(readFileSync);\n    // Create the language service host to allow the LS to communicate with the host\n    const servicesHost = {\n        getScriptFileNames: () => [typingsIndex, ...Object.keys(files)],\n        getScriptVersion: (filepath) => files[filepath] && files[filepath].version.toString(),\n        getScriptSnapshot: (filepath) => {\n            var data;\n            if (files[filepath]) {\n                data = files[filepath].data;\n                return ts.ScriptSnapshot.fromString(data);\n            }\n            if (!_existsSync(filepath) && filepath.indexOf('node_modules/typescript/lib') !== -1 && parseFloat(ts.version) >= 2) {\n                var basename = Path.basename(filepath);\n                filepath = `${Path.dirname(filepath)}/lib.${basename}`;\n            }\n            // TODO: Too slow. Read package.json and restrict finding.\n            if (!_existsSync(filepath)) {\n                return undefined;\n            }\n            data = _readFileSync(filepath).toString();\n            return ts.ScriptSnapshot.fromString(data);\n        },\n        getCurrentDirectory: _.constant(process.cwd()),\n        getCompilationSettings: _.constant(compilerOptions),\n        getDefaultLibFileName: (options) => ts.getDefaultLibFilePath(options),\n    };\n    // Create the language service files\n    const service = ts.createLanguageService(servicesHost, ts.createDocumentRegistry());\n\n    logd(service.getCompilerOptionsDiagnostics());\n\n    function eventCallback(event, index, events) {\n        var eventPath = event.path;\n        switch (event.type) {\n            case \"add\":\n            case \"change\":\n                var info = files[eventPath]; \n                if (!info) {\n                    info = { version: 0, data: \"\", dtsFile: null};\n                    files[eventPath] = info;\n                }\n                info.version++;\n                info.data = event.data;\n                var {outputFiles, emitSkipped} = service.getEmitOutput(eventPath);\n                var {jsFile, mapFile, dtsFile} = parseOutputFiles(outputFiles);\n                event.data = jsFile.text;\n                event.changeFileSuffix(\"js\");\n                if (mapFile) {\n                    event.applySourceMap(JSON.parse(mapFile.text));\n                }\n                if (dtsFile) {\n                    var fields = _.pick(event, [\"type\", \"basePath\", \"data\", \"path\"]);\n                    fields.data = dtsFile.text;\n                    var newEvent = new Event(fields);\n                    newEvent.changeFileSuffix(\"d.ts\");\n                    events.push(newEvent);\n                    info.dtsFile = newEvent.path;\n                }\n                // Log diagnostics.\n                var diagnostics = []\n                    .concat(service.getSyntacticDiagnostics(eventPath))\n                    .concat(service.getSemanticDiagnostics(eventPath));\n                logd(diagnostics);\n                // Log fatal error.\n                if (emitSkipped) {\n                    log.warn(`Emit of ${eventPath} failed (fatal errors).`);\n                }\n                break;\n            case \"remove\":\n                var dtsFile = _.get(info, \"dtsFile\");\n                if (dtsFile) {\n                    var dtsFileEvent = _.find(events, event => event.path === dtsFile);\n                    if (dtsFileEvent) {\n                        dtsFileEvent.type = \"remove\";\n                    }\n                }\n                delete files[eventPath];\n                break;\n        }\n        return event;\n    }\n\n    return op.stream.map(events => {\n        _.each(events, eventCallback);\n        return events;\n    });\n}\n\nfunction parseOutputFiles(outputFiles) {\n    var jsFile = _.find(outputFiles, f => _.endsWith(f.name, \".js\"));\n    var mapFile = _.find(outputFiles, f => _.endsWith(f.name, \".js.map\"));\n    var dtsFile = _.find(outputFiles, f => _.endsWith(f.name, \".d.ts\"));\n    return { jsFile, mapFile, dtsFile };\n}\n\nfunction getCompilerOptions(options = {}) {\n    var tsconfigFile = path.join(npmPackage, \"tsconfig.json\");\n    if (existsSync(tsconfigFile)) {\n        var tsconfig = require(tsconfigFile);\n        options = _.assign({}, _.get(tsconfig, \"compilerOptions\", {}), options);\n    }\n    if (options.target) {\n        options.target = getEnumOption(ts.ScriptTarget, options.target);\n    }\n    if (options.module) {\n        options.module = getEnumOption(ts.ModuleKind, options.module);\n    }\n    if (options.moduleResolution) {\n        if (String(options.moduleResolution).toLocaleLowerCase() === \"node\") {\n            options.moduleResolution = \"NodeJs\";\n        }\n        options.moduleResolution = getEnumOption(ts.ModuleResolutionKind, options.moduleResolution);\n    }\n    if (options.inlineSourceMap || options.sourceMap) {\n        options.inlineSources = true;\n    }\n    return options;\n}\n\nfunction getEnumOption(collection, value) {\n    var valueUpper = String(value).toLocaleUpperCase();\n    var result = _.chain(collection)\n        .findKey(value => String(value).toUpperCase() === valueUpper)\n        .toNumber()\n        .value();\n    if (_.isNaN(result)) {\n        result = value;\n    }\n    return result;\n}\n\nmodule.exports = exports[\"default\"];"]}